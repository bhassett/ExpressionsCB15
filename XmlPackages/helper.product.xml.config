<?xml version="1.0" standalone="yes"?>
<!-- ###################################################################################################### -->
<!-- Licensed by Interprise Solutions.					                                                            -->
<!-- http://www.InterpriseSolutions.com														                                          -->
<!-- For details on this license please visit  the product homepage at the URL above.		                    -->
<!-- THE ABOVE NOTICE MUST REMAIN INTACT.                                                                   -->
<!-- ###################################################################################################### -->
<package version="2.1" displayname="producttabcontrol" debug="false" includeentityhelper="false">
  
  <PackageTransform debug="false" >
    
    <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:ise="urn:ise" exclude-result-prefixes="ise" >
      <xsl:output method="html" indent="yes"/>
      <xsl:param name="SectionType" select="FIELD/SECTION_TYPE" />
      <xsl:variable name="ProductID" select="FIELD/ProductID"/>
      <xsl:variable name="ProductName" select="FIELD/ProductName"/>
      <xsl:variable name="ProductUrl" select="FIELD/ProductUrl"/>
      <xsl:variable name="ProductDesc" select="FIELD/ProductDesc"/>
      <xsl:variable name="CategoryID" select="FIELD/CategoryID"/>
      
      <xsl:variable name="item_counter" select="FIELD/ITEM_COUNTER" />
      <xsl:variable name="skin_id" select="FIELD/SKIN_ID" />
      <xsl:variable name="item_type" select="FIELD/ITEM_TYPE" />
      
      <xsl:template match="/">
        <xsl:choose>
          <!-- DISPLAY_SHAREBOX -->
          <xsl:when test="$SectionType='DISPLAY_SHAREBOX'">
          <xsl:if test="ise:AppConfigBool('ShowSocialMediaShareBox') = 'true'">
          <div class="socialmedia_sharebox">

            <xsl:variable name="ProductImage" select="ise:UrlEncode(concat($ProductUrl,'/../',ise:GetProductImageSource('product',$ProductID,'medium')))"/>
            <xsl:variable name="ProductName" select="ise:UrlEncode($ProductName)"/>
            <xsl:variable name="ProductUrl" select="ise:UrlEncode($ProductUrl)"/>
            <xsl:variable name="ProductDesc" select="ise:UrlEncode($ProductDesc)"/>
            <xsl:variable name="HideSubscribeButtons" select="ise:AppConfig('HideSocialMediaShareButton')"/>

            <xsl:if test="contains($HideSubscribeButtons, 'facebook') = false">
              <!-- Facebook Share Button -->
              <a class="facebook" target="_blank">
                <xsl:attribute name="title">Share this product on facebook</xsl:attribute>
                <xsl:attribute name="href">
                  <xsl:value-of select="concat('http://www.facebook.com/sharer/sharer.php?',
                              's=100',
                              '&amp;p[title]=', $ProductName, 
                              '&amp;p[url]=', $ProductUrl, 
                              '&amp;p[summary]=', $ProductDesc,
                              '&amp;p[images][0]=',$ProductImage)" disable-output-escaping="yes">
                  </xsl:value-of>
                </xsl:attribute>
              </a>    
            </xsl:if>

            <!-- Twitter Share Button -->
            <xsl:if test="contains($HideSubscribeButtons, 'twitter')=true">
              <a class="twitter" target="_blank">
                <xsl:attribute name="title">Share this product on twitter</xsl:attribute>
                <xsl:attribute name="href">
                  <xsl:value-of select="concat('https://twitter.com/share?',
                                                       'text=', $ProductName,
                                                       '&amp;url=', $ProductUrl)"
                                disable-output-escaping="yes"  />
                </xsl:attribute>
                <xsl:attribute name="data-count">none</xsl:attribute>
              </a>
            </xsl:if>

            <!-- Digg Share Button -->
            <xsl:if test="contains($HideSubscribeButtons, 'digg') = false">
              <a class="digg" target="_blank">
                <xsl:attribute name="title">Share this product on digg</xsl:attribute>
                <xsl:attribute name="href">
                  <xsl:value-of select="concat('http://digg.com/submit?',
                                                         'url=', $ProductUrl, 
                                                         '&amp;title=', $ProductName)"
                                                            disable-output-escaping="yes"  />
                </xsl:attribute>
              </a>
            </xsl:if>
            
            <!-- StumbleUpon Share Button-->
            <xsl:if test="contains($HideSubscribeButtons, 'stumble') = false">
              <a class="stumble" target="_blank">
                <xsl:attribute name="title">Share this product on stumbleupon</xsl:attribute>
                <xsl:attribute name="href">
                  <xsl:value-of select="concat('http://www.stumbleupon.com/submit?',
                                                       'url=', $ProductUrl)"
                                 disable-output-escaping="yes"  />
                </xsl:attribute>
              </a>
            </xsl:if>

            <!-- Google Share Button-->
            <xsl:if test="contains($HideSubscribeButtons, 'google') = false">
              <a class="google" target="_blank">
                <xsl:attribute name="title">Share this product on google+</xsl:attribute>
                <xsl:attribute name="href">
                  <xsl:value-of select="concat('https://plus.google.com/share?',
                                                       'url=', $ProductUrl)"
                               disable-output-escaping="yes"  />
                </xsl:attribute>
              </a>
            </xsl:if>

            <!-- Email Share Button -->
            <xsl:if test="contains($HideSubscribeButtons, 'email') = false">
              <a class="email">
                <xsl:attribute name="title">Email this product to friend</xsl:attribute>
                <xsl:attribute name="href">
                  emailproduct.aspx?productId=<xsl:value-of select="$ProductID" disable-output-escaping="yes" />&amp;categoryid=<xsl:value-of select="$CategoryID" disable-output-escaping="yes" />
                </xsl:attribute>
              </a>
            </xsl:if>
            
          </div>
          </xsl:if>
        </xsl:when>

          <!-- DISPLAY_COMMENTBOX-->
          <xsl:when test="$SectionType='DISPLAY_COMMENTBOX'">
            <xsl:if test="ise:AppConfigBool('ShowSocialMediaCommentBox') = 'true'">
              <div id="fb-root"></div>
              <script type="text/javascript">
                (function (d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
                fjs.parentNode.insertBefore(js, fjs);
                } (document, 'script', 'facebook-jssdk'));
              </script>
              
              <div class="socialmedia_commentbox">
              <div class="header">
                  <xsl:value-of select="ise:StringResource('showproduct.aspx.54')" disable-output-escaping="yes" ></xsl:value-of>
              </div>
              
              <div class="fb-comments">
                <xsl:attribute name="data-href"><xsl:value-of select="$ProductUrl" disable-output-escaping="yes" ></xsl:value-of></xsl:attribute>
                <xsl:attribute name="data-num-posts">100</xsl:attribute>
                <xsl:attribute name="data-width">670</xsl:attribute>
              </div>
              </div>
            </xsl:if>
            
          </xsl:when>

          <!-- DISPLAY_NAV_LINKS-->
          <xsl:when test="$SectionType='DISPLAY_NAV_LINKS'">
            <xsl:if test="FIELD/HIDEPRODUCTNEXTPREVLINKS = 'false'">
              <table class="navLinkscontainer">
                <tr>
                  <xsl:if test="FIELD/PREV_HREF" >
                    <td class="prev_href" >
                      <a class="ProductNavLink" href="{FIELD/PREV_HREF}">
                        <xsl:choose >
                          <xsl:when test="FIELD/USE_GRAPHICS = 'true'">
                            <img alt="" title="" src="{concat('skins/Skin_', FIELD/SKIN_ID, '/images/previous.png')}" />
                          </xsl:when>
                          <xsl:otherwise>
                            <span>
                              <xsl:value-of select="FIELD/PREV_NO_IMAGE_TEXT" />
                            </span>
                          </xsl:otherwise>
                        </xsl:choose>
                      </a>
                    </td>
                  </xsl:if>
                  <xsl:if test="FIELD/INCLUDEUPLINK = 'true' and string-length(FIELD/ENTITY_SENAME) > 0" >
                    <td class="up_href">
                      <a class="ProductNavLink" href="{FIELD/UP_HREF}">
                        <xsl:choose >
                          <xsl:when test="FIELD/USE_GRAPHICS = 'true'">
                            <img alt="" title="" src="{concat('skins/Skin_', FIELD/SKIN_ID, '/images/up.png')}" />
                          </xsl:when>
                          <xsl:otherwise>
                            <span>
                              <xsl:value-of select="FIELD/UP_NO_IMAGE_TEXT" />
                            </span>
                          </xsl:otherwise>
                        </xsl:choose>
                      </a>
                    </td>
                  </xsl:if>
                  <xsl:if test="FIELD/NEXT_HREF" >
                    <td class="next_href">
                      <a class="ProductNavLink" href="{FIELD/NEXT_HREF}">
                        <xsl:choose >
                          <xsl:when test="FIELD/USE_GRAPHICS = 'true'">
                            <img alt="" title="" src="{concat('skins/Skin_', FIELD/SKIN_ID, '/images/next.png')}" />
                          </xsl:when>
                          <xsl:otherwise>
                            <span>
                              <xsl:value-of select="FIELD/NEXT_NO_IMAGE_TEXT" />
                            </span>
                          </xsl:otherwise>
                        </xsl:choose>
                      </a>
                    </td>
                  </xsl:if>
                </tr>
              </table>
            </xsl:if>
          </xsl:when>
          
          <!-- DISPLAY_ADDTOCARTFORM-->
          <xsl:when test="$SectionType='DISPLAY_ADDTOCARTFORM'">
              <xsl:choose>
              <!--show if call to order has value-->
                  <xsl:when test="FIELD/CALL_TO_ORDER_TEXT">
                  <form>
                      <font class="CallToOrder">
                          <xsl:value-of select="FIELD/CALL_TO_ORDER_TEXT"  disable-output-escaping="yes"/>
                      </font>
                  </form>
                  </xsl:when>

            <!--continue if show buy button is true / not whole sale and customer default price not whole sale -->
            <xsl:when test="FIELD/SHOW_BUY_BUTTON = 'true' and
                            FIELD/USE_WEBSTORE_PRICING = 'true' or
                            (FIELD/IS_WHOLESALE_ONSITE = 'false' or FIELD/IS_CUSTOMER_DEFAULT_PRICE_NOT_WHOLESALE = 'false') and
                            FIELD/IS_SHOW_ITEM_PRICE_WHEN_LOGIN = 'false'" >
              
                <!--if item type is electronic download-->
                <xsl:if test="$item_type = 'Electronic Download'">
                    <xsl:choose>
                        <!--if the downloadable item is not available-->
                        <xsl:when test="FIELD/NO_AVAILABLE_DOWNLOAD_TEXT">
                            <span>
                                <xsl:value-of select="FIELD/NO_AVAILABLE_DOWNLOAD_TEXT"  disable-output-escaping="yes"/>
                            </span>
                        </xsl:when>

                        <!--if customer is not registered-->
                        <xsl:when test="FIELD/CUSTOMER_NOT_REGISTERED_TEXT">
                            <span>
                                <xsl:value-of select="FIELD/CUSTOMER_NOT_REGISTERED_TEXT"  disable-output-escaping="yes"/>
                            </span>
                        </xsl:when>
                    </xsl:choose>
                </xsl:if>

                <xsl:if test="not(FIELD/NO_AVAILABLE_DOWNLOAD_TEXT) and not(FIELD/CUSTOMER_NOT_REGISTERED_TEXT)">
              <div id="{concat('pnlAddToCartForm_', $item_counter)}" >
                
                <form class= "AddToCartclass" method="POST" id="{concat('AddToCartForm_', $item_counter)}" name="{concat('AddToCartForm_', $item_counter)}" action="{FIELD/FORM_ACTION}" >
                  <input type="hidden" name="ProductID" id="{concat('ProductID_', $item_counter)}" value="{$item_counter}" />
                  <input type="hidden" name="IsWishList" value="0" id="{concat('IsWishList', '_', $item_counter)}" />
                  
                  <input type="hidden" name="IsAddToGiftRegistry" value="0" id="{concat('IsAddToGiftRegistry_', $item_counter)}" />
                  <input type="hidden" name="IsAddToGiftRegistryOption" value="0" id="{concat('IsAddToGiftRegistryOption_', $item_counter)}" />
                  
                  <input type="hidden" id="UpsellProducts" name="UpsellProducts" value="" />

                  <xsl:if test="$item_type = 'Kit'">
                    <!--if has pricing type -->
                    <xsl:if test="FIELD/KIT_PRICING_TYPE">
                      <input type="hidden" name="KitPricingType" id="KitPricingType" value="{FIELD/KIT_PRICING_TYPE}" />
                    </xsl:if>
                    <input type="hidden" name="KitItems" id="KitItems" class="KitItems" value="" />
                    <!--if this kit item has query string-->
                    <xsl:if test="FIELD/ITEM_KIT_IS_EDITMODE">
                      <input name="IsEditKit" type="hidden" value="true" />
                      <input name="KitCartID" type="hidden" value="{FIELD/KIT_CART_ID}" />
                    </xsl:if>
                  </xsl:if>

                  <span id="{concat('ctrlQuantity_', $item_counter)}">
                  </span>
                  
                  <xsl:if test="FIELD/SHOW_MEASURE = 'true'">
                    <span class="showproduct_unitmeasure" id="{concat('ctrlUnitMeasure_', $item_counter)}">
                    </span>
                  </xsl:if>
                  <br /><br />
                  <ul class="stack button-group radius">
                  <!--Add to cart button-->
                  <xsl:choose>
                    <xsl:when test="FIELD/ITEM_KIT_IS_EDITMODE and FIELD/ITEM_KIT_IS_EDITMODE = 'true'" >
                      <input type="submit" class="button" id="{concat('AddToCart_', $item_counter)}" name="{concat('AddToCart_', $item_counter)}"
                        data-contentKey="shoppingcart.cs.33"
                        data-contentValue="{FIELD/EDITCART_BUTTON_CAPTION}"
                        data-contentType="string resource"
                        value="{FIELD/EDITCART_BUTTON_CAPTION}" />
                    </xsl:when>
                    <xsl:otherwise>
                      
                      <li><a href="#" class="button" onclick="document.getElementById('{concat('AddToCartForm_', $item_counter)}').submit();"
                        id="{concat('AddToCart_', $item_counter)}"
                        data-contentKey="AppConfig.CartButtonPrompt"
                        data-contentValue="{FIELD/ADDTOCART_BUTTON_CAPTION}"
                        data-contentType="string resource"
                      >Add to Cart</a></li>
                      <!-- <input type="submit" class="button" id="{concat('AddToCart_', $item_counter)}" name="{concat('AddToCart_', $item_counter)}"                           
                             data-contentKey="AppConfig.CartButtonPrompt"
                             data-contentValue="{FIELD/ADDTOCART_BUTTON_CAPTION}"
                             data-contentType="string resource"
                             value="{FIELD/ADDTOCART_BUTTON_CAPTION}"
                             /> -->
                    </xsl:otherwise>
                  </xsl:choose>
                  <!--wishlist button-->
                  <!--test if show wishlist button-->
                  <xsl:if test="FIELD/SHOWWISHLISTBUTTON = 'true'">
                      <li><a href="#" class="button secondary" onclick="document.getElementById('{concat('AddToCartForm_', $item_counter)}').submit();"
                        id="{concat('AddToWishList_',$item_counter)}"
                        data-contentKey="AppConfig.WishButtonPrompt"
                        data-contentValue="{FIELD/WISHLIST_CAPTION}"
                        data-contentType="string resource"
                      >Add to Wish List</a></li>
                      <!-- <input type="submit" class="button" id="{concat('AddToWishList_',$item_counter)}" name="{concat('AddToWishList_',$item_counter)}" 
                             data-contentKey="AppConfig.WishButtonPrompt"
                             data-contentValue="{FIELD/WISHLIST_CAPTION}"
                             data-contentType="string resource"
                             value="{FIELD/WISHLIST_CAPTION}" /> -->
                  </xsl:if>
                </ul>

                  <br />

                  <xsl:if test="FIELD/SHOW_GIFTREGISTRY_BUTTON and FIELD/SHOW_GIFTREGISTRY_BUTTON = 'true'">
                    
                    <br />
                    
                    <select id="{concat('giftregistryOptions_',$item_counter)}" name="giftregistryOptions" class="giftregistry-options" data-gift-registry-select="">
                      <option value="0" selected="true"><xsl:value-of select="ise:StringResourceTextOnly('editgiftregistry.aspx.25')"></xsl:value-of></option>
                       <xsl:for-each select="FIELD/REGISTRIES">
                        <option value="{ current()/VALUE }" >
                          <xsl:value-of select="current()/TEXT"></xsl:value-of>
                        </option>
                      </xsl:for-each>
                    </select>
                      
                    <br />
                    
                    <div class="showproduct_registry-button-wrapper" data-gift-registry-button="" >
                      
                      <input type="submit" class="site-button addToCartButton-right-small-space content" id="{concat('addRegistryButton_',$item_counter)}" name="{concat('addRegistryButton_',$item_counter)}" 
                             value="{ise:StringResourceTextOnly('editgiftregistry.aspx.23')}"
                             data-contentKey="editgiftregistry.aspx.23"
                             data-contentValue="{ise:StringResourceTextOnly('editgiftregistry.aspx.23')}"
                             data-contentType="string resource"
                             />
                      
                      <input type="submit" class="site-button content" id="{concat('addOptionRegistryButton_',$item_counter)}" name="{concat('addOptionRegistryButton_',$item_counter)}" 
                             value="{ise:StringResourceTextOnly('editgiftregistry.aspx.24')}"
                             data-contentKey="editgiftregistry.aspx.24"
                             data-contentValue="{ise:StringResourceTextOnly('editgiftregistry.aspx.24')}"
                             data-contentType="string resource"
                             />
                    </div>
                    
                  </xsl:if>

                  <xsl:if test="$item_type = 'Matrix Group'">
                    
                    <script>

                      <![CDATA[ $add_windowLoad(function() { ]]>

                        var id = <xsl:value-of select="$item_counter" />;
                        
                        <![CDATA[
                        
                          var addtoCartFormControl = ise.Products.AddToCartFormController.getForm(id);
                          if(typeof addtoCartFormControl !== 'object') {
                                
                              return;
                          }
                          
                          if(typeof addtoCartFormControl.product !== 'object') {
                                
                              return;
                          }
                          
                          var currentProduct = addtoCartFormControl.product;
                          
                          if(currentProduct.itemType == 'Matrix Group') //handles the matrix item
                          {
                          
                            $('div[data-gift-registry-button]').hide();
                            $('select[data-gift-registry-select]').hide();
                            
                            var matrixProductGroup = ise.Products.ProductController.getProduct(id);
                            matrixProductGroup.onMatrixItemAssignmentSuccessfulForGiftRegistryOptions = function(showRegistry) {
                              
                              if(!showRegistry)
                              {
                                $('div[data-gift-registry-button]').fadeOut();
                                $('select[data-gift-registry-select]').fadeOut();
                                
                              }
                              else
                              {
                                $('div[data-gift-registry-button]').fadeIn();
                                $('select[data-gift-registry-select]').fadeIn();
                              }
                              
                            }
                            
                          }
                        
                      });
                      
                    ]]>
                      
                    </script>

                  </xsl:if>
                  
                </form>
              </div>

              <script type="text/javascript" >
                $add_windowLoad(function() {

                var itemcounter = <xsl:value-of select="$item_counter" />;
                var selectedUOM = '<xsl:value-of select="FIELD/SELECTED_UOM" />';

                if (selectedUOM != ''){
                var product = ise.Products.ProductController.getProduct(itemcounter);
                product.setUnitMeasure(selectedUOM);
                var uomControl = new ise.Products.UnitMeasureControl(itemcounter, 'ctrlUnitMeasure_' + itemcounter);
                uomControl.setProduct(product);
                }
                });
                
                $(document).ready(function(){

                <xsl:if test="FIELD/SHOW_GIFTREGISTRY_BUTTON = 'true'">
                    var str = ise.Configuration.getConfigValue("GiftRegistry.Enabled");
                    if (str == 'GiftRegistry.Enabled') {
                      ise.Configuration.registerConfig('GiftRegistry.Enabled', 'true');
                    }
                    
                    ise.StringResource.registerString('editgiftregistry.error.5', '<xsl:value-of select="ise:StringResourceTextOnly('editgiftregistry.error.5')" ></xsl:value-of>');
                    ise.StringResource.registerString('editgiftregistry.error.6', '<xsl:value-of select="ise:StringResourceTextOnly('editgiftregistry.error.6')" ></xsl:value-of>');
                  </xsl:if>
                  
                  InitAddToCartFormScript('<xsl:value-of select="FIELD/CART_JSON_SCRIPT" />');
                  
                })
              </script>
                </xsl:if>
            </xsl:when>
              
          </xsl:choose>
          </xsl:when>

          <!-- DISPLAY_PRODUCT_IMAGE-->
          <xsl:when test="$SectionType='DISPLAY_PRODUCTIMAGE'">
            <xsl:variable name="pagination" select="FIELD/PAGINATION"></xsl:variable>
            <xsl:variable name="switching" select="FIELD/SWITCHING"></xsl:variable>
            <xsl:variable name="itemcode" select="FIELD/ITEM_CODE"></xsl:variable>
            <script type="text/javascript">
              function switchImage(itemCode, imgMediumPath, imgIndex, defaultStyle) {
              var photo = $('.photo-gallery[itemcode=' + itemCode + '] .mainPix img');
              photo.attr("src", imgMediumPath);

              var paging = $('.photo-gallery[itemcode=' + itemCode + '] ul li a');
              paging.attr("class", defaultStyle);
              paging.eq(imgIndex-1).attr("class", defaultStyle + '-selected');
              }
            </script>
            <div class="photo-gallery" itemcode="{$itemcode}">
              <div class="mainPix">
                <!-- set the default medium image -->
                <xsl:for-each select="FIELD/IMAGE">
                  <xsl:choose>
                    <xsl:when test="current()/DEFAULT='true'">
                      <img data-contentKey="" data-contentType="image" class="content" src="{current()/MEDIUM/SRC}" />
                    </xsl:when>
                  </xsl:choose>
                </xsl:for-each>
              </div>
              <ul>
                <xsl:for-each select="FIELD/IMAGE">
                  <li>
                    <a class="th" href="javascript:void(0)" index="{position()}">
                      <!-- paging style -->
                      <xsl:attribute name="class">
                        paging-<xsl:value-of select="$pagination" /><xsl:if test="current()/DEFAULT='true'">-selected</xsl:if>
                      </xsl:attribute>

                      <!-- image switch -->
                      <!-- note: set switching to default onmouseover because other attributes are no longer supported by new browser-->
                      <xsl:attribute name="onmouseover">
                        switchImage('<xsl:value-of select="$itemcode" />',
                        '<xsl:value-of select="current()/MEDIUM/SRC" />',
                        '<xsl:value-of select="position()" />',
                        'paging-<xsl:value-of select="$pagination" />')
                      </xsl:attribute>

                      <!-- Pagination (e.g. thumbnail, number, bullet) -->
                      <xsl:choose>
                        <xsl:when test="$pagination='thumbnail'">
                          <img src="{current()/MICRO/SRC}" />
                        </xsl:when>
                        <xsl:when test="$pagination='number'">
                          <xsl:value-of select="position()" />
                        </xsl:when>
                        <xsl:otherwise></xsl:otherwise>
                      </xsl:choose>
                    </a>
                  </li>
                </xsl:for-each>
              </ul>
            </div>

          </xsl:when>

          <!-- DISPLAY_CARTCONTROL-->
          <xsl:when test="$SectionType='DISPLAY_CARTCONTROL'">
            <xsl:variable name="ItemCounter" select="FIELD/ITEM_COUNTER" />
            <xsl:variable name="ItemType" select="FIELD/ITEM_TYPE" />
            <xsl:variable name="ItemCode" select="FIELD/ITEM_CODE" />
            <xsl:variable name="CartControlID" select="concat('CartControlID_', $ItemCounter)" />
            <xsl:variable name="UnitMeasureControlID" select="concat('UnitMeasureControlID_', $ItemCounter)" />
            <xsl:variable name="PriceControlID" select="concat('PriceControlID_', $ItemCounter)" />
            <xsl:variable name="PromoPriceControlID" select="concat('PromoPriceControlID_', $ItemCounter)" />
            <xsl:variable name="QuantityControlID" select="concat('QuantityControlID_', $ItemCounter)" />
            <xsl:variable name="StockHintControlID" select="concat('StockHintControlID_', $ItemCounter)" />
            <xsl:variable name="MatrixOptionControlID" select="concat('MatrixOptionControlID_', $ItemCounter)" />
            <xsl:variable name="KitOptionControlID" select="concat('KitOptionControlID_', $ItemCounter)" />
            <xsl:variable name="MessageBoardControlID" select="concat('MessageBoardControlID_', $ItemCounter)" />
            <xsl:variable name="AddToControlID" select="concat('AddToControlID_', $ItemCounter)" />

            <xsl:choose>
              <!-- MatrixGroup Cart Control -->
              <xsl:when test="$ItemType = 'Matrix Group'">
                <div id="{$CartControlID}" class="price-control"></div>
                <div style="padding:10px;">
                  <div style="display:table;">
                    <div style="display:table-cell;vertical-align:middle;padding:2px;">
                      <div id="{$QuantityControlID}" class="quantity-control"></div>
                    </div>
                    <div style="display:table-cell;vertical-align:middle;padding:2px;">
                      <div id="{$AddToControlID}" class="addto-control"></div>
                    </div>
                  </div>
                  <!-- Matrix Options -->
                  <div id="{$MatrixOptionControlID}" class="matrixopt-control">
                    <xsl:for-each select="FIELD/MATRIX_OPTIONS/HEADER_ATTRIBUTE">
                      <xsl:variable name="MatrixOptID" select="concat('MatrixAttribute_',current()/ITEM_COUNTER,'_',current()/HEADER_CTR)" />
                      <select name="MatrixOpt" id="{$MatrixOptID}" class="selected" >
                        <option value="{current()/HEADER_ATTRIBUTE_CODE}">
                          <xsl:value-of select="concat(current()/HEADER_CUSTOM_TEXT, ' ', current()/HEADER_ATTRIBUTE_DESCRIPTION) " />
                        </option>
                        <xsl:for-each select="current()/ATTRIBUTE_ITEM" >
                          <option value="{current()/ITEM_ATTRIBUTE_CODE}">
                            <xsl:value-of select="current()/ITEM_ATTRIBUTE_DESCRIPTION" disable-output-escaping="yes" />
                          </option>
                        </xsl:for-each>
                      </select>
                      <br />
                    </xsl:for-each>
                  </div>
                  <div id="{$MessageBoardControlID}" class="messageboard-control"></div>
                  <div id="{$PriceControlID}" class="price-control"></div>
                  <div id="{$PromoPriceControlID}" class="promoprice-control"></div>
                  <div id="{$UnitMeasureControlID}" class="unitmeasure-control"></div>
                  <div id="{$StockHintControlID}" class="stockhint-control"></div>
                </div>
              </xsl:when>
              <!-- Kit Cart Control -->
              <xsl:when test="$ItemType = 'Kit'">
                <div id="{$CartControlID}" class="price-control"></div>
                <div style="padding:10px;">
                  <div style="display:table;">
                    <div style="display:table-cell;vertical-align:middle;padding:2px;">
                      <div id="{$QuantityControlID}" class="quantity-control"></div>
                    </div>
                    <div style="display:table-cell;vertical-align:middle;padding:2px;">
                      <div id="{$AddToControlID}" class="addto-control"></div>
                    </div>
                  </div>

                  <!-- Kit Options -->
                  <div id="{$KitOptionControlID}" class="kitopt-control">
                    <!-- Currency Symbol-->
                    <input type="hidden" name="currencysymbol" value="{FIELD/KIT_OPTIONS/CURRENCY_SYMBOL}" />
                    <xsl:for-each select="FIELD/KIT_OPTIONS/KIT_GROUP">
                      <xsl:variable name="KitControlType" select="current()/GROUP_TYPE" />
                      <xsl:variable name="KitGroupID" select="concat('KitGroup_', current()/GROUP_ID)" />
                      <xsl:variable name="GroupID" select="current()/GROUP_ID" />
                      <div id="{$KitGroupID}" kitgroup="{current()/GROUP_ID}" class="kitgroup">
                        <div class="kitgroup-header">
                          <xsl:value-of select="current()/GROUP_CODE" />
                          <span class="icon">+</span>
                        </div>
                        <div class="kitgroup-content">
                          <xsl:for-each select="current()/KIT_ITEM">
                            <xsl:variable name="ItemSelected" select="current()/ITEM_SELECTED"></xsl:variable>
                            <xsl:variable name="RowClass">
                              <xsl:choose>
                                <xsl:when test="current()/ITEM_SELECTED = 'true'">selected</xsl:when>
                                <xsl:otherwise>normal</xsl:otherwise>
                              </xsl:choose>
                            </xsl:variable>

                            <!-- Optional None Radio button -->
                            <xsl:choose>
                              <xsl:when test="$KitControlType = 'Optional' and position() = 1">
                                <div class="{$RowClass}">
                                  <input type="radio" name="{$KitGroupID}" value="" class="itemcontrol">
                                    <xsl:if test="$ItemSelected = 'true'">
                                      <xsl:attribute name="checked">checked</xsl:attribute>
                                    </xsl:if>
                                  </input>
                                  <b>None</b>
                                  <div></div>
                                  <input type="hidden" class="itemprice" value="0" />
                                </div>
                                <hr class="linebreak"/>
                              </xsl:when>
                            </xsl:choose>

                            <!-- Controls -->
                            <div class="{$RowClass}">
                              <xsl:choose>
                                <xsl:when test="$KitControlType = 'Multi-Select'">
                                  <input type="checkbox" name="{$KitGroupID}" value="" class="itemcontrol">
                                    <xsl:if test="$ItemSelected = 'true'">
                                      <xsl:attribute name="checked">checked</xsl:attribute>
                                    </xsl:if>
                                  </input>
                                </xsl:when>
                                <xsl:when test="$KitControlType = 'Required'">
                                  <input type="radio" name="{$KitGroupID}" value="" class="itemcontrol">
                                    <xsl:if test="$ItemSelected = 'true'">
                                      <xsl:attribute name="checked">checked</xsl:attribute>
                                    </xsl:if>
                                  </input>
                                </xsl:when>
                                <xsl:when test="$KitControlType = 'Optional'">
                                  <input type="radio" name="{$KitGroupID}" value="" class="itemcontrol">
                                    <xsl:if test="$ItemSelected = 'true'">
                                      <xsl:attribute name="checked">checked</xsl:attribute>
                                    </xsl:if>
                                  </input>
                                </xsl:when>
                              </xsl:choose>
                              <b>
                                <xsl:value-of select="current()/ITEM_PRICE_FORMATTED" />
                              </b>
                              <xsl:choose>
                                <xsl:when test="current()/ITEM_FREESTOCK > 0">
                                  <img src="images/instock.png" height="22px" style="float:right;"></img>
                                </xsl:when>
                                <xsl:otherwise>
                                  <img src="images/outofstock.png" height="22px" style="float:right;">"</img>
                                </xsl:otherwise>
                              </xsl:choose>
                              <div>
                                <xsl:value-of select="current()/ITEM_NAME" />
                              </div>
                              <input type="hidden" class="itemprice" value="{current()/ITEM_PRICE}" itemid="{current()/ITEM_ID}" groupid="{$GroupID}" />
                            </div>
                            <xsl:if test="not(position() = last())">
                              <hr class="linebreak"/>
                            </xsl:if>
                          </xsl:for-each>
                        </div>
                      </div>
                    </xsl:for-each>
                  </div>

                  <div id="{$MessageBoardControlID}" class="messageboard-control"></div>
                  <div id="{$PriceControlID}" class="price-control"></div>
                  <div id="{$PromoPriceControlID}" class="promoprice-control"></div>
                  <div id="{$UnitMeasureControlID}" class="unitmeasure-control"></div>

                </div>
              </xsl:when>
              <!-- Stock and others Cart Control -->
              <xsl:otherwise>
                <div id="{$CartControlID}" class="price-control"></div>
                <div style="display:table;margin-right:15px;float:right;">
                  <div style="display:table-cell;vertical-align:middle;padding:2px;">
                    <div id="{$StockHintControlID}" class="stockhint-control"></div>
                  </div>
                  <div style="display:table-cell;vertical-align:middle;padding:2px;">
                    <div id="{$PriceControlID}" class="price-control"></div>
                    <div id="{$PromoPriceControlID}" class="promoprice-control"></div>
                  </div>
                  <div style="display:table-cell;vertical-align:middle;padding:2px;">
                    <div id="{$UnitMeasureControlID}" class="unitmeasure-control"></div>
                  </div>
                  <div style="display:table-cell;vertical-align:middle;padding:2px;">
                    <div id="{$QuantityControlID}" class="quantity-control"></div>
                  </div>
                  <div style="display:table-cell;vertical-align:middle;padding:2px;">
                    <div id="{$AddToControlID}" class="addto-control"></div>
                  </div>
                </div>
              </xsl:otherwise>
            </xsl:choose>
            <input type="hidden" id="quantityRegex" value="{FIELD/SETTINGS/QUANTITY_REGEX}"></input>
            <script type="text/javascript" src="jscripts/jquery/jquery.cart.js" />
            <script type="text/javascript">
              var cartCtrl = "#<xsl:value-of select="$CartControlID"></xsl:value-of>";
              var unitMeasureCtrl = "#<xsl:value-of select="$UnitMeasureControlID"></xsl:value-of>";
              var priceCtrl = "#<xsl:value-of select="$PriceControlID"></xsl:value-of>";
              var promoPriceCtrl = "#<xsl:value-of select="$PromoPriceControlID"></xsl:value-of>";
              var quantityCtrl = "#<xsl:value-of select="$QuantityControlID"></xsl:value-of>";
              var stockHintCtrl = "#<xsl:value-of select="$StockHintControlID"></xsl:value-of>";
              var matrixOptionCtrl = "#<xsl:value-of select="$MatrixOptionControlID"></xsl:value-of>";
              var kitOptionCtrl = "#<xsl:value-of select="$KitOptionControlID"></xsl:value-of>";
              var messageBoardCtrl = "#<xsl:value-of select="$MessageBoardControlID"></xsl:value-of>";
              var addToCtrl = "#<xsl:value-of select="$AddToControlID"></xsl:value-of>";

              var options = {
              itemType: '<xsl:value-of select="$ItemType"></xsl:value-of>',
              itemCounter: <xsl:value-of select="$ItemCounter"></xsl:value-of>,
              itemCode: '<xsl:value-of select="$ItemCode"></xsl:value-of>',
              restrictedQty: <xsl:value-of select="FIELD/SETTINGS/RESTRICTED_QTY"></xsl:value-of>,
              minOrder: <xsl:value-of select="FIELD/SETTINGS/MIN_ORDER"></xsl:value-of>,
              hidePrice: <xsl:value-of select="FIELD/SETTINGS/HIDE_PRICE"></xsl:value-of>,
              showBuyButton: <xsl:value-of select="FIELD/SETTINGS/SHOW_BUY_BUTTON"></xsl:value-of>,
              reqRegistration: <xsl:value-of select="FIELD/SETTINGS/REQUIRES_REGISTRATION"></xsl:value-of>,
              callToOrder: <xsl:value-of select="FIELD/SETTINGS/CALL_TO_ORDER"></xsl:value-of>,
              unitMeasures: <xsl:value-of select="FIELD/SETTINGS/UNIT_MEASURES_INTRINSICS"></xsl:value-of>,
              showStockHint: <xsl:value-of select="FIELD/SETTINGS/SHOW_STOCKHINTS"></xsl:value-of>,
              showActualStock: <xsl:value-of select="FIELD/SETTINGS/SHOW_ACTUALSTOCK"></xsl:value-of>,
              imgInStock: 'images/instock.png',
              imgOutOfStock: 'images/outofstock.png',
              addToCartAction: '<xsl:value-of select="FIELD/SETTINGS/ADDTOCART_ACTION"></xsl:value-of>',
              hideUnitMeasure: <xsl:value-of select="FIELD/SETTINGS/HIDE_UNITMEASURE"></xsl:value-of>,
              useWebStorePricing: <xsl:value-of select="FIELD/SETTINGS/USEWEBSTOREPRICING"></xsl:value-of>,
              isWholeSale: <xsl:value-of select="FIELD/SETTINGS/ISWHOLESALE"></xsl:value-of>,
              isCustomerWholeSale: <xsl:value-of select="FIELD/SETTINGS/ISCUSTOMER_WHOLESALE"></xsl:value-of>,
              hasNoAvailableDownloadFile: <xsl:value-of select="FIELD/SETTINGS/HAS_NO_AVAILABLE_DOWNLOAD_FILE"></xsl:value-of>,
              isDownloadFileNotExists: <xsl:value-of select="FIELD/SETTINGS/IS_DOWNLOAD_FILE_NOT_EXISTS"></xsl:value-of>,
              isCustomerNotRegistered: <xsl:value-of select="FIELD/SETTINGS/IS_CUSTOMER_NOT_REGISTERED"></xsl:value-of>
              };
              
              var myplugin = new $(cartCtrl).cartcontrol(
              options,
              $(unitMeasureCtrl),
              $(priceCtrl),
              $(promoPriceCtrl),
              $(quantityCtrl),
              $(stockHintCtrl),
              $(matrixOptionCtrl),
              $(kitOptionCtrl),
              $(messageBoardCtrl),
              $(addToCtrl)
              );
            </script>
          </xsl:when>

          <!-- DISPLAY_REVIEWS -->
          <xsl:when test="$SectionType='DISPLAY_REVIEWS'">
            <xsl:variable name="ItemCode" select="FIELD/ITEMCODE"></xsl:variable>
            <xsl:variable name="DisplayListOnly" select="FIELD/LISTONLY"></xsl:variable>
            <xsl:variable name="SortDefault" select="FIELD/SORTING_DEFAULT"></xsl:variable>
            <xsl:choose>
              <xsl:when test="$DisplayListOnly = 1">
                <xsl:call-template name="ReviewList"></xsl:call-template>
              </xsl:when>
              <xsl:otherwise>
                <div class="reviews" itemcode="{$ItemCode}">
                  <div style="display:inline-block;">
                    <h3>
                      <xsl:value-of select="ise:StringResource('itempopup.aspx.8')" disable-output-escaping="yes" />
                    </h3>
                  </div>
                  <div style="display:inline-block;float:right;">
                    <select class="sorter" sortdefault="{FIELD/SORTING_DEFAULT}">
                      <option value="1">
                        <xsl:if test="$SortDefault = 1"><xsl:attribute name="selected">true</xsl:attribute></xsl:if>
                        <xsl:value-of select="ise:StringResource('ratings.cs.1')" disable-output-escaping="yes" />
                      </option>
                      <option value="2">
                        <xsl:if test="$SortDefault = 2"><xsl:attribute name="selected">true</xsl:attribute></xsl:if>
                        <xsl:value-of select="ise:StringResource('ratings.cs.2')" disable-output-escaping="yes" />
                      </option>
                      <option value="4">
                        <xsl:if test="$SortDefault = 4"><xsl:attribute name="selected">true</xsl:attribute></xsl:if>
                        <xsl:value-of select="ise:StringResource('ratings.cs.3')" disable-output-escaping="yes" />
                      </option>
                      <option value="8">
                        <xsl:if test="$SortDefault = 8"><xsl:attribute name="selected">true</xsl:attribute></xsl:if>
                        <xsl:value-of select="ise:StringResource('ratings.cs.4')" disable-output-escaping="yes" />
                      </option>
                      <option value="16">
                        <xsl:if test="$SortDefault = 16"><xsl:attribute name="selected">true</xsl:attribute></xsl:if>
                        <xsl:value-of select="ise:StringResource('ratings.cs.5')" disable-output-escaping="yes" />
                      </option>
                      <option value="32">
                        <xsl:if test="$SortDefault = 32"><xsl:attribute name="selected">true</xsl:attribute></xsl:if>
                        <xsl:value-of select="ise:StringResource('ratings.cs.6')" disable-output-escaping="yes" />
                      </option>
                    </select>
                  </div>
                  <xsl:call-template name="ReviewList"></xsl:call-template>
                </div>
              </xsl:otherwise>
            </xsl:choose>
            <!--<script type="text/javascript" src="jscripts/itemcontrol.js" />-->
            <script type="text/javascript">
              
               //item review onchange of sorting dropdown event
              $(".reviews .sorter").change(function () {
                  var itemcode = $(this).parent().parent().attr("itemcode");
                  var sorting = $(this).val();
                  var reviewlist = $(this).parent().siblings(".reviewlist");

                  $.ajax({
                      type: "POST",
                      url: "ActionService.asmx/GetItemReviews",
                      data: JSON.stringify({ itemCode: itemcode, sort: sorting }),
                      dataType: "json",
                      contentType: "application/json; charset=utf-8",
                      success: function (result) {
                          reviewlist.replaceWith(result.d); //update reviews
                      },
                      error: function (result, textStatus, exception) {
                          console.log(exception);
                      }
                  });
              });
              
              
              function ratecomment(itemcode, vote, votercustomercode, votercontactcode, customercode, contactcode)
              {
                     $.ajax({
                      type: "POST",
                      url: "ActionService.asmx/VoteItemReview",
                      data: JSON.stringify({ itemCode: itemcode, voterCustomerCode:votercustomercode, voterContactCode:votercontactcode, vote:vote, customerCode:customercode, contactCode:contactcode }),
                      dataType: "json",
                      contentType: "application/json; charset=utf-8",
                      success: function (result) {
                          var sorter = $(".reviews[itemcode=" + itemcode + "]").children().children(".sorter");
                          $(sorter).val(4).change(); 
                      },
                      error: function (result, textStatus, exception) {
                          console.log(exception);
                      }
                  });
              }
              
            </script>
          </xsl:when>

          <!-- DISPLAY_REVIEWCONTROL -->
          <xsl:when test="$SectionType='DISPLAY_REVIEWCONTROL'">
            <xsl:variable name="ItemCode" select="FIELD/ITEM_CODE" />
            <xsl:variable name="CurrentComment" select="FIELD/CURRENT_COMMENT"></xsl:variable>
            <xsl:variable name="CurrentRating" select="FIELD/CURRENT_RATING"></xsl:variable>
            <div class="myreview" itemcode="{$ItemCode}" currentrating="{$CurrentRating}">
              <h3>
                <xsl:value-of select="ise:StringResource('itempopup.aspx.9')" disable-output-escaping="yes" />
              </h3>
              <div class="head">
                <select class="ratingoption">
                  <option rating="0" value="" ></option>
                  <option rating="1" value="1" >
                    <xsl:value-of select="ise:StringResource('itempopup.aspx.10')" disable-output-escaping="yes" />
                  </option>
                  <option rating="2" value="2">
                    <xsl:value-of select="ise:StringResource('itempopup.aspx.11')" disable-output-escaping="yes" />
                  </option>
                  <option rating="3" value="3"><xsl:value-of select="ise:StringResource('itempopup.aspx.12')" disable-output-escaping="yes" />
                  </option>
                  <option rating="4" value="4">
                    <xsl:value-of select="ise:StringResource('itempopup.aspx.13')" disable-output-escaping="yes" />
                  </option>
                  <option rating="5" value="5">
                    <xsl:value-of select="ise:StringResource('itempopup.aspx.14')" disable-output-escaping="yes" /></option>
                </select>
                <span class="ratinglabel"></span>
              </div>
              <div class="body"><textarea class="ratingtxt"></textarea></div>
              <div class="footer"><input type="button" value="SAVE" class="saverating"></input></div>
            </div>
            <script type="text/javascript" src="jscripts/jquery/jquery.rating.js" />
            <script type="text/javascript">
              $(document).ready(function(){
                var itemcode = '<xsl:value-of select="$ItemCode"></xsl:value-of>';
                var ratingoption = $(".myreview[itemcode=" + itemcode  + "]").children(".head").children(".ratingoption");
                var ratinglabel = $(".myreview[itemcode=" + itemcode + "]").children(".head").children(".ratinglabel");
                var ratingtxt = $(".myreview[itemcode=" + itemcode + "]").children(".body").children(".ratingtxt");
                var sorter = $(".reviews[itemcode=" + itemcode + "]").children().children(".sorter");
                var btnsave = $(".myreview[itemcode=" + itemcode + "]").children(".footer").children(".saverating");
                var currentrating = '<xsl:value-of select="$CurrentRating"></xsl:value-of>';
                
                //assign values if item has been reviewed
                $(ratingoption).val(currentrating);
                $(ratingtxt).html('<xsl:value-of select="$CurrentComment"  disable-output-escaping="yes"></xsl:value-of>');
                
                $(ratingoption).rating({showCancel:false,cancelValue:'',startValue:null});
                
                $(ratingoption).bind("change", function() {
                  var selected = $(".myreview[itemcode=" + itemcode  + "] .head .ratingoption :selected ").html();
                   $(ratinglabel).html(selected);
                });
                
                $(btnsave).click(function(){
                  var proceed = true;
                  if($(ratingoption).val() == ""){ proceed = false; alert("Please select rating"); } //todo: update alert
                  if($(ratingtxt).val() == "") { proceed = false; alert("Please enter comment"); } //todo: update alert
                  
                  if(proceed)
                  {
                    var rating = $(ratingoption).val();
                    var comment = $(ratingtxt).val();
                    
                    $.ajax({
                        type: "POST",
                        url: "ActionService.asmx/CreateUpdateItemReview",
                        data: JSON.stringify({ itemCode: itemcode, rating: rating, comment: comment }),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function (result) { $(sorter).val(4).change();   currentrating = rating; },  
                        error: function (result, textStatus, exception) {}});
                  }
                });
              });
            </script>
          </xsl:when>

          <!-- DISPLAY_SUBSTITUTEPRODUCT -->
          <xsl:when test="$SectionType='DISPLAY_SUBSTITUTEPRODUCT'">
            <xsl:variable name="ItemCode" select="FIELD/ITEM_CODE" />
            <xsl:variable name="ItemPopOnClick" select="FIELD/ITEM_POPONCLICK" />
            <div class="substitute" style="display:block;clear:both;">
              <xsl:if test="FIELD/SHOW_HEADER = 1">
                <xsl:if test="count(FIELD/SUBSTITUTE_ITEMS/SUBSTITUTE_ITEM) > 0">
                  <h3>Other Similar Products</h3>
                  <br />
                </xsl:if>
              </xsl:if>
              <xsl:for-each select="FIELD/SUBSTITUTE_ITEMS/SUBSTITUTE_ITEM">
                <div class="itembox">
                  <a href="{current()/ITEM_LINK}">
                    <xsl:if test="$ItemPopOnClick = 1">
                      <xsl:attribute name="onclick">
                        getItemPopup('<xsl:value-of select="$ItemCode"></xsl:value-of>','<xsl:value-of select="current()/ITEM_CODE"></xsl:value-of>', event)
                      </xsl:attribute>
                    </xsl:if>
                    <div style="text-align:center;"><img src="{current()/IMG_SRC}" /></div>
                    <div style="text-align:center;"><xsl:value-of select="current()/ITEM_NAME"></xsl:value-of></div>
                  </a>
                </div>
              </xsl:for-each>
            </div>
          </xsl:when>

          <!-- DISPLAY_ACCESSORIES -->
          <xsl:when test="$SectionType='DISPLAY_ACCESSORIES'">
            <xsl:variable name="ItemCode" select="FIELD/ITEM_CODE" />
            <xsl:variable name="ItemPopOnClick" select="FIELD/ITEM_POPONCLICK" />
            <div class="accessories" style="display:block;clear:both;">
              <xsl:if test="FIELD/SHOW_HEADER = 1">
                <xsl:if test="count(FIELD/ACCESSORY_ITEMS/ACCESSORY_ITEM) > 0">
                  <h3>Products You Might Also Like</h3>
                  <br />
                </xsl:if>
              </xsl:if>
              <xsl:for-each select="FIELD/ACCESSORY_ITEMS/ACCESSORY_ITEM">
                <div class="itembox">
                  <a href="{current()/ITEM_LINK}">
                    <xsl:if test="$ItemPopOnClick = 1">
                      <xsl:attribute name="onclick">getItemPopup('<xsl:value-of select="$ItemCode"></xsl:value-of>','<xsl:value-of select="current()/ITEM_CODE"></xsl:value-of>', event)</xsl:attribute>
                    </xsl:if>
                    <div style="text-align:center;"><img src="{current()/IMG_SRC}" /></div>
                    <div style="text-align:center;"><xsl:value-of select="current()/ITEM_NAME"></xsl:value-of></div>
                  </a>
                </div>
              </xsl:for-each>
            </div>
          </xsl:when>

          <!-- DISPLAY_NAV_LINK-->
          <xsl:when test="$SectionType='DISPLAY_NAV_LINK'">
            <xsl:if test="(FIELD/ITEMCODE_PREV != '')">
              <a>
                <xsl:attribute name="onclick">getItemPopup('<xsl:value-of select="FIELD/ITEMCODE_CURRENT"></xsl:value-of>','<xsl:value-of select="FIELD/ITEMCODE_PREV"></xsl:value-of>', event)</xsl:attribute>
                </a>
            </xsl:if>
            <xsl:if test="(FIELD/ITEMCODE_NEXT != '')">
              <a>
                <xsl:attribute name="onclick">getItemPopup('<xsl:value-of select="FIELD/ITEMCODE_CURRENT"></xsl:value-of>','<xsl:value-of select="FIELD/ITEMCODE_NEXT"></xsl:value-of>', event)</xsl:attribute>
                </a>
            </xsl:if>
          </xsl:when>

          <!--DISPLAY_NOTIFYONPRICEDROP-->
          <xsl:when test="$SectionType='PRICEDROP_NOTIFICATION_CONTROL'">
            <div id="pnlNotifyPriceDrop_{$item_counter}"></div>

            <script type="text/javascript">
              $add_windowLoad(function() {
                var counter = <xsl:value-of select="$item_counter"></xsl:value-of>;
                var hasSubscription = <xsl:value-of select="FIELD/SUBSCRIBED"></xsl:value-of>;
                
                ise.StringResource.registerString('AppConfig.NotifyOnPriceDropButtonPrompt', '<xsl:value-of select="FIELD/BUTTON_PROMPT"></xsl:value-of>');
                ise.StringResource.registerString('AppConfig.NotifyOnPriceDropMessagePrompt', '<xsl:value-of select="FIELD/MESSAGE_PROMPT"></xsl:value-of>');
                
                var product = ise.Products.ProductController.getProduct(counter);
                var notifyPriceDropControl = new ise.Products.NotifyPriceDropControl(counter, 'pnlNotifyPriceDrop_' + counter, hasSubscription);
            
                if (product.getItemType() != "Matrix Group")
                {
                  notifyPriceDropControl.setProduct(product);
                }
                else
                {
                  var matrixProductGroup = ise.Products.ProductController.getProduct(counter);
                  
                  if(matrixProductGroup != null) {
                  
                    if(typeof matrixProductGroup.onMatrixItemAssignmentSuccessfulForPriceDrop != 'undefined') {
                    
                      matrixProductGroup.onMatrixItemAssignmentSuccessfulForPriceDrop = function(found) {
                        
                        if (found)
                        {
                          notifyPriceDropControl.setProduct(product);
                          $('#pnlNotifyPriceDrop_' + counter).show();
                        }
                        else
                        {
                          $('#pnlNotifyPriceDrop_' + counter).hide();
                        }
                        
                      };
                    }
                    
                  }
                }
            });
            </script>
          </xsl:when>

          <!-- DISPLAY_NOTIFYONITEMAVAIL-->
          <xsl:when test="$SectionType='AVAILABILITY_NOTIFICATION_CONTROL'">
            <div id="pnlNotifyOnItemAvail_{$item_counter}"></div>

            <script type="text/javascript">
              $add_windowLoad(function() {
              var counter = <xsl:value-of select="$item_counter"></xsl:value-of>;
                var hasSubscription = <xsl:value-of select="FIELD/SUBSCRIBED"></xsl:value-of>;
                
                ise.StringResource.registerString('AppConfig.NotifyOnItemAvailButtonPrompt', '<xsl:value-of select="FIELD/BUTTON_PROMPT"></xsl:value-of>');
                ise.StringResource.registerString('AppConfig.NotifyOnItemAvailMessagePrompt', '<xsl:value-of select="FIELD/MESSAGE_PROMPT"></xsl:value-of>');
                
                var product = ise.Products.ProductController.getProduct(counter);
                var notifyOnItemAvailControl = new ise.Products.NotifyOnItemAvailControl(counter, 'pnlNotifyOnItemAvail_' + counter, hasSubscription);
                
                if (product.getItemType() != "Matrix Group")
                {
                  notifyOnItemAvailControl.setProduct(product);
                }
                else
                {
                  var matrixProductGroup = ise.Products.ProductController.getProduct(counter);
                  
                  if(matrixProductGroup != null) {
                  
                    if(typeof matrixProductGroup.onMatrixItemAssignmentSuccessfulForItemAvailability != 'undefined') {
                    
                      matrixProductGroup.onMatrixItemAssignmentSuccessfulForItemAvailability = function(found) {
                        if (found)
                        {
                          notifyOnItemAvailControl.setProduct(product);
                          $('#pnlNotifyOnItemAvail_' + counter).show();
                        }
                        else
                        {
                          $('#pnlNotifyOnItemAvail_' + counter).hide();
                        }
                      };
                      
                    }  
                    
                  }
                }
            });
            </script>
          </xsl:when>

          <!-- DISPLAY_EXPECTEDSHIPDATE-->
          <xsl:when test="$SectionType='DISPLAY_EXPECTEDSHIPDATE'">
            <span class="notifyexpshipdate">
              <xsl:value-of select="FIELD/EXPECTEDSHIPDATE"></xsl:value-of>
            </span>
          </xsl:when>

          <!-- RATING_CONTROL-->
          <xsl:when test="$SectionType='RATING_CONTROL'">
            <span class="product-rating">
              <xsl:for-each select="FIELD/RATING_GRAPH/GRAPH">
                <i>
                  <xsl:attribute name="class">
                    <xsl:choose>
                      <xsl:when test="current() = 'Empty'">icon-star-empty</xsl:when>
                      <xsl:when test="current() = 'Half'">icon-star-half-empty</xsl:when>
                      <xsl:when test="current() = 'Full'">icon-star</xsl:when>
                      <xsl:otherwise></xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>
                </i>
              </xsl:for-each>
            </span>
          </xsl:when>

          <!-- STOREPICKUP_SHOPPING_OPTION-->
          <xsl:when test="$SectionType='STOREPICKUP_SHOPPING_OPTION'">

            <xsl:if test="FIELD/SHOW_STOREPICKUP_OPTION = 'true'">

              <xsl:if test="ise:IsCartHasGiftRegistryItem() = false">
              
                <a href="javascript:void(0);" id="{concat('lnkStorePickUpOption_', FIELD/ITEM_COUNTER)}">
                  <i class='icon-map-marker'></i><xsl:value-of select="ise:StringResource('checkoutstore.aspx.1')" disable-output-escaping="yes" />
                </a>

                <script>
                  
                  <![CDATA[ 
                    $add_windowLoad(function() {
                  ]]>
                
                    var id = <xsl:value-of select="FIELD/ITEM_COUNTER" disable-output-escaping="yes" />;
                    
                   <![CDATA[     
                   
                      var el = $('#lnkStorePickUpOption_' + id).unbind("click")
                                                               .click(loadStorePickup);

                      if(typeof ise.Products.AddToCartFormController !== 'object') { 
                          el.hide(); 
                          return;
                      };
                          
                      var addtoCartFormControl = ise.Products.AddToCartFormController.getForm(id);
                      if(typeof addtoCartFormControl !== 'object') {
                          el.hide(); 
                          return;
                      }
                      
                      if(typeof addtoCartFormControl.product !== 'object') {
                          el.hide(); 
                          return;
                      }
                      
                      var currentProduct = addtoCartFormControl.product;
                      if(currentProduct.itemType == "Matrix Group") //handles the matrix item
                      {
                          
                          var matrixProductGroup = ise.Products.ProductController.getProduct(id);
                          if(matrixProductGroup != null && typeof matrixProductGroup.onMatrixItemAssignmentSuccessful != 'undefined') { 
                            
                              matrixProductGroup.onMatrixItemAssignmentSuccessful = function(found) {
                              
                                if(found) el.show(); 
                                else el.hide();
                                
                              };
                              
                          }
                          
                          el.hide(); 
                          return;
                      }
                      
                      function loadStorePickup() {

                          var quantityControl = addtoCartFormControl.getQuantityControl();
                          if(typeof quantityControl !== 'object' ) { 
                              alert('Quantity control does not exist please check you code');
                              return;
                          }
                          
                          //handles the kit composition
                          var seletedQuantity = quantityControl.getValue();
                          var itemType = currentProduct.getItemType();
                          var composition = (itemType.toUpperCase() === 'kit'.toUpperCase())? currentProduct.getComposition(): '';
                          var productId = currentProduct.getId();
                         
                          var basePlugin = new jqueryBasePlugin();
                          basePlugin.downloadPlugin('components/instore_pickup/setup.js', function () {

                              var loader = new instorePluginLoader();
                              loader.start(function (config) {

                                  config.showAddToCart = true;
                                  config.cartItem = {
                                      itemCounter: productId,
                                      itemCode: currentProduct.getItemCode(),
                                      unitMeassureCode: currentProduct.getUnitMeasure(),
                                      itemType: itemType,
                                      quantity: seletedQuantity,
                                      kitComposition: composition
                                  }
                                  
                                  //added to show product only.
                                  config.messages.MESSAGE_ADD_TO_CART_BUTTON_TEXT = ise.StringResource.getString('AppConfig.CartButtonPrompt');
                                  
                                  $.fn.InStorePickup.setup(config);
                              
                              });
                              
                          });
                      }             

                  });
                  
              ]]>
                
              </script>
                
              </xsl:if>
              
            </xsl:if>
           
          </xsl:when>

          <!-- MATRIX_CONTROL-->
          <xsl:when test="$SectionType='MATRIX_CONTROL'">
            <div class="matrix-selection">
              <xsl:variable name="ItemCounter" select="FIELD/ITEM_COUNTER"></xsl:variable>

              <div id="pnlMatrixAttribute_Error_{$ItemCounter}" class="MatrixAttributeError" ></div>
              <div id="pnlMatrixAttribute_SelectCaption_{$ItemCounter}" style="display:none;"></div>

              <xsl:for-each select="FIELD/MATRIX_ATTRIBUTES/MATRIX_ATTRIBUTE">
                <xsl:variable name="ControlID">
                  MatrixAttribute_<xsl:value-of select="$ItemCounter"></xsl:value-of>_<xsl:value-of select="current()/COUNTER"></xsl:value-of>
                </xsl:variable>
                <select class="matrix-selector" id="{ise:StrTrim($ControlID)}" name="{ise:StrTrim($ControlID)}">
                  <!-- header -->
                  <option value="{current()/CODE}"><xsl:value-of select="ise:StringResource('showproduct.aspx.35')" disable-output-escaping="yes"></xsl:value-of>&#160;<xsl:value-of select="current()/DESC"></xsl:value-of></option>
                  <!-- content -->
                  <xsl:for-each select="current()/VALUES/VALUE">
                    <option value="{current()/CODE}"><xsl:value-of select="current()/DESC"></xsl:value-of></option>
                  </xsl:for-each>
                </select>&#160;
              </xsl:for-each>

              <script>
                $add_windowLoad(function(){
                var itemcounter = <xsl:value-of select="$ItemCounter" />;
                var selectedmatrix = '<xsl:value-of select="FIELD/SELECTED_MATRIX_ITEMCODE" />';
                var selectionType = '<xsl:value-of select="ise:AppConfig('MatrixAttributeSelectorType')"></xsl:value-of>';
                var message = {
                  NO_MATRIX_ITEM: '<xsl:value-of select="ise:StringResource('showproduct.aspx.39')" disable-output-escaping="yes" />',
                  SELECT_CAPTION: '<xsl:value-of select="ise:StringResource('showproduct.aspx.40')" disable-output-escaping="yes" />'
                };
                var attributes = [];
                <xsl:for-each select="FIELD/MATRIX_ATTRIBUTES/MATRIX_ATTRIBUTE">attributes.push("<xsl:value-of select="current()/CODE" />");</xsl:for-each>

                ise.StringResource.registerString('showproduct.aspx.39', message.NO_MATRIX_ITEM);
                ise.StringResource.registerString('showproduct.aspx.40', message.SELECT_CAPTION);

                var product = ise.Products.ProductController.getProduct(itemcounter);
                var matrixGroupControl = new ise.Products.MatrixAttributeGroupControl(itemcounter);
                matrixGroupControl.setProduct(product);
                matrixGroupControl.setMatrixAttributeSelectionType(selectionType);
                matrixGroupControl.setHasMatrixSelection(selectedmatrix);

                $.each(attributes, function(key, val){
                  var counter = key + 1;
                  var id = "MatrixAttribute_" + itemcounter + "_" + counter;
                  var control = new ise.Products.MatrixAttributeControl(id, val)
                  matrixGroupControl.registerAttributeControl(control);
                });
                
                if(selectedmatrix != ''){
                  product.chooseMatrixItem(selectedmatrix);
                }
                
                });
              </script>

            </div>
          </xsl:when>

          <!-- LOYALTY_POINTS-->
          <xsl:when test="$SectionType='LOYALTY_POINTS'">
            <xsl:variable name="ItemCounter" select="FIELD/ITEM_COUNTER"></xsl:variable>
            <xsl:variable name="ItemType" select="FIELD/ITEM_TYPE"></xsl:variable>
            <xsl:variable name="PurchaseMultiplier" select="FIELD/PURCHASE_MULTIPLIER"></xsl:variable>
            <xsl:variable name="Points" select="FIELD/POINTS"></xsl:variable>
            <xsl:variable name="IsPointsComputed" select="FIELD/IS_POINTS_COMPUTED"></xsl:variable>

            <div id="pnlLoyaltyPoints_{$ItemCounter}" style="display:none;" class="loyalty-points">
              <i class="icon-gift"></i>
              <xsl:value-of select="ise:StringResource('showproduct.aspx.76')" disable-output-escaping="yes" ></xsl:value-of>
              <span class="points">
                <xsl:value-of select="$Points"></xsl:value-of>
              </span>
              <xsl:value-of select="ise:StringResource('showproduct.aspx.77')" disable-output-escaping="yes" ></xsl:value-of>
            </div>
            <script>
              $(document).ready(function(){
                var counter = <xsl:value-of select="$ItemCounter"></xsl:value-of>;
                var multiplier = <xsl:value-of select="$PurchaseMultiplier"></xsl:value-of>;
                var itemtype = '<xsl:value-of select="$ItemType"></xsl:value-of>';
                var product = ise.Products.ProductController.getProduct(counter);
                var loyaltyPointsControl = null;
                
                if(itemtype != 'kit') { 
                  loyaltyPointsControl = new ise.Products.LoyaltyPointsControl(counter, 'pnlLoyaltyPoints_' + counter, multiplier);
                }
                else {
                  loyaltyPointsControl = new ise.Products.KitLoyaltyPointsControl(counter, 'pnlLoyaltyPoints_' + counter, multiplier);
                }
                loyaltyPointsControl.setProduct(product);
              });
            </script>
          </xsl:when>
          
          <!-- SKU_CONTROL-->
          <xsl:when test="$SectionType='SKU_CONTROL'">
            <xsl:variable name="ItemCounter" select="FIELD/ITEM_COUNTER"></xsl:variable>
            <div id="pnlDisplaySKU_{$ItemCounter}" class="sku-control"></div>

            <script type="text/javascript">
              $(document).ready(function(){
              var counter = <xsl:value-of select="$ItemCounter"></xsl:value-of>;
              ise.StringResource.registerString('showproduct.aspx.78', '<xsl:value-of select="ise:StringResourceTextOnly('showproduct.aspx.78')" ></xsl:value-of>');
              var product = ise.Products.ProductController.getProduct(counter);
              var skuControl = new ise.Products.SKUControl(counter, 'pnlDisplaySKU_' + counter);
              skuControl.setProduct(product);
              });
            </script>
            
          </xsl:when>

          <!-- REVIEW_CONTROL-->
          <xsl:when test="$SectionType='REVIEW_CONTROL'">
            <div id="divRating">
            </div>

            <script>
              var itemCode = '<xsl:value-of select="FIELD/ITEM_CODE" disable-output-escaping="yes" />';
              var itemCounter = <xsl:value-of select="FIELD/ITEM_COUNTER" disable-output-escaping="yes" />;
              
              var basePlugin = new jqueryBasePlugin();
              basePlugin.downloadPlugin('components/rating/setup.js', function () {
                var loader = new instorePluginLoader();
                loader.start(function (config) {
                  config.ItemCode = itemCode;
                  config.ItemCounter = itemCounter;
                  $("#divRating").Rating.setup(config);
                });
              });

            </script>
          </xsl:when>

          <xsl:otherwise>
        </xsl:otherwise>
        </xsl:choose>
      </xsl:template>

      <xsl:template name="ReviewList">
        <xsl:variable name="CustomerCode" select="FIELD/CUSTOMERCODE"></xsl:variable>
        <xsl:variable name="ContactCode" select="FIELD/CONTACTCODE"></xsl:variable>
        <xsl:variable name="IsRegistered" select="FIELD/CUSTOMER_REGISTERED" />
        <xsl:variable name="ItemCode" select="FIELD/ITEMCODE" />
        <xsl:choose>
          <!-- NoReviews -->
          <xsl:when test="count(FIELD/REVIEWS/REVIEW) = 0">
            <ul class="reviewlist">
              <li>No reviews yet</li>
            </ul>
          </xsl:when>
          <!-- WithReviews -->
          <xsl:otherwise>
            <ul class="reviewlist">
              <xsl:for-each select="FIELD/REVIEWS/REVIEW">
                <xsl:variable name="RevCustomerCode" select="current()/REVIEWER_CUSTOMERCODE" />
                <xsl:variable name="RevContactCode" select="current()/REVIEWER_CONTACTCODE" />
               
                <li>
                  <div class="review-header">
                    <span class="author">
                      <xsl:value-of select="concat(current()/FIRST_NAME, ' ', current()/LAST_NAME)"></xsl:value-of>
                    </span>
                    <span class="created">
                      <xsl:value-of select="current()/DATE_CREATED"></xsl:value-of>
                    </span>
                    <br />
                    <span class="ratings">
                      <xsl:value-of select="current()/RATING_STARS" disable-output-escaping="yes"></xsl:value-of>
                    </span>
                  </div>
                  <div class="review-body">
                      <xsl:value-of select="current()/COMMENT" disable-output-escaping="yes"></xsl:value-of>
                  </div>
                  <div class="review-footer">
                    <span class="like">
                      <!-- check if owner of comment -->
                      <xsl:if test="not($CustomerCode = $RevCustomerCode) and $IsRegistered = 'true'">
                        Was this review helpful?
                        <input type="button" class="ratecomment" value="Yes" onclick="ratecomment('{$ItemCode}','YES','{$CustomerCode}','{$ContactCode}','{$RevCustomerCode}', '{$RevContactCode}')"></input>
                        <input type="button" class="ratecomment" value="No" onclick="ratecomment('{$ItemCode}','NO','{$CustomerCode}','{$ContactCode}','{$RevCustomerCode}', '{$RevContactCode}')"></input>
                        <br />
                      </xsl:if>
                    </span>
                    <span class="helpful">
                      <xsl:value-of select="current()/HELPFUL_COUNT"></xsl:value-of> found this review helpful,
                      <xsl:value-of select="current()/NOTHELPFUL_COUNT"></xsl:value-of> did not
                      <br />
                    </span>
                  </div>

                  <!-- comment division -->
                  <xsl:if test="not(position() = last())">
                    <hr class="linebreak" />
                  </xsl:if>
                </li>
              </xsl:for-each>
            </ul>
          </xsl:otherwise>
        </xsl:choose>
        
      </xsl:template>
    </xsl:stylesheet>
    
  </PackageTransform>
</package>